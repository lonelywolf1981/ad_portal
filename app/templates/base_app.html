<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title if title else "AD Tools" }}</title>

  <!-- Apply theme early to minimize flash between light/dark -->
  <script>
    (function () {
      const KEY = "adportal_theme";
      let theme = null;
      try { theme = localStorage.getItem(KEY); } catch (e) { theme = null; }
      if (!theme) {
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        theme = prefersDark ? "dark" : "light";
      }
      document.documentElement.setAttribute("data-bs-theme", theme);
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link href="/static/app.css" rel="stylesheet">
</head>
<body class="bg-body-tertiary">
  <nav class="navbar navbar-expand-lg bg-body border-bottom">
    <div class="container">
      <a class="navbar-brand" href="/">AD Tools</a>
      <div class="ms-auto d-flex gap-2 align-items-center flex-wrap">
        <button
          type="button"
          class="btn btn-outline-secondary btn-sm theme-toggle"
          data-theme-toggle
          aria-label="Переключить тему"
          title="Тема"
        ></button>
        {% if user and user.get("settings") %}
          <a class="btn btn-outline-primary btn-sm" href="/settings">Настройки</a>
        {% endif %}
        <a class="btn btn-outline-secondary btn-sm" href="/logout">Выход</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    {% block content %}{% endblock %}
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/theme.js"></script>

  <script>
    // Show user-visible message on HTMX server errors (5xx/4xx)
    document.addEventListener('htmx:responseError', function(ev) {
      var target = ev.detail.target;
      if (target) {
        var code = ev.detail.xhr ? ev.detail.xhr.status : 0;
        target.innerHTML = "<div class='alert alert-danger py-2 mb-0'>Ошибка сервера" + (code ? " (" + code + ")" : "") + ". Попробуйте позже.</div>";
      }
    });
  </script>

  <script>
    // UI hygiene for HTMX result panes:
    // - Clear stale alerts/results when switching tabs.
    // - Clear results when the corresponding input becomes empty.
    (function () {
      function clearEl(id) {
        var el = document.getElementById(id);
        if (el) el.innerHTML = "";
      }

      // Clear results on main tab switch
      document.addEventListener('shown.bs.tab', function (ev) {
        var t = ev && ev.target;
        if (!t) return;
        // Only react for the main tabs container
        if (!t.closest || !t.closest('#mainTabs')) return;
        clearEl('user-results');
        clearEl('host-logon-results');
        // Keep shares results on tab switch; if empty, load once on first open.
        if (t.id === 'tab-shares') {
          var sharesEl = document.getElementById('shares-results');
          if (sharesEl && !sharesEl.innerHTML.trim()) {
            var h = document.getElementById('shares-hidden-cb');
            var hv = (h && h.checked) ? '1' : '0';
            if (window.htmx && typeof window.htmx.ajax === 'function') {
              window.htmx.ajax('GET', '/shares/search?hidden=' + hv, { target: '#shares-results', swap: 'innerHTML' });
            }
          }
        }
        // presence-results is intentionally NOT cleared: it has auto-load and acts as a dashboard
      });

      // Clear user/host search results when input becomes empty
      document.addEventListener('input', function (ev) {
        var el = ev && ev.target;
        if (!el || !el.name) return;
        var v = (el.value || '').trim();
        if (el.name === 'q') {
          // Users search input lives under #pane-users
          if (el.closest && el.closest('#pane-users') && v.length === 0) {
            clearEl('user-results');
          }
        }
        if (el.name === 'target') {
          if (el.closest && el.closest('#pane-host') && v.length === 0) {
            clearEl('host-logon-results');
          }
        }
      });
    })();
  </script>
</body>
</html>
