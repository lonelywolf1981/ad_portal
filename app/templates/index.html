{% extends "base_app.html" %}
{% block content %}
  <div id="net-scan-poll"  class="d-none" hx-get="/net-scan/poll?last={{ net_scan_last_token }}" hx-trigger="load, every 10s" hx-swap="outerHTML"></div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h1 class="h6 mb-2">Сеанс</h1>

      <div class="row small">
        <div class="col-md-6">
          <div class="text-secondary">Пользователь: <strong>{{ user["u"] }}</strong></div>
          <div class="text-secondary">Тип: <strong>{{ user["auth"] }}</strong></div>
          <div class="text-secondary">Доступ к настройкам: <strong>{{ "Да" if user.get("settings") else "Нет" }}</strong></div>
        </div>
        <div class="col-md-6">
          <div class="text-secondary">Отображаемое имя: <strong>{{ user.get("dn","") }}</strong></div>
        </div>
      </div>

      <div class="mt-2 pt-2 border-top small text-secondary">
        <div>Последний запуск: <strong>{{ net_scan_last_run if net_scan_last_run else "—" }}</strong></div>
        <div>Результат: {% if net_scan_last_summary %}{{ net_scan_last_summary }}{% else %}—{% endif %}</div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-presence" data-bs-toggle="tab" data-bs-target="#pane-presence" type="button" role="tab" aria-controls="pane-presence" aria-selected="true">
            Сопоставления
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-users" data-bs-toggle="tab" data-bs-target="#pane-users" type="button" role="tab" aria-controls="pane-users" aria-selected="false">
            Поиск пользователей
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-host" data-bs-toggle="tab" data-bs-target="#pane-host" type="button" role="tab" aria-controls="pane-host" aria-selected="false">
            Кто залогинен на хосте
          </button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="mainTabsContent">

        <div class="tab-pane fade show active" id="pane-presence" role="tabpanel" aria-labelledby="tab-presence">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-2">
            <h2 class="h6 mb-0">Сопоставления user ↔ host</h2>
            <a class="btn btn-outline-secondary btn-sm" id="presence-export" href="/presence/export.xlsx">Скачать XLSX</a>
          </div>

          <form
            class="row g-2 align-items-center"
            hx-get="/presence/search"
            hx-target="#presence-results"
            hx-swap="innerHTML"
            hx-trigger="submit, keyup changed delay:350ms from:input[name='q']"
          >
            <div class="col-md-8">
              <input
                type="text"
                class="form-control"
                name="q"
                placeholder="Поиск по имени хоста, IP или логину"
                autocomplete="off"
                oninput="(function(el){var v=(el.value||'').trim();var a=document.getElementById('presence-export');if(a){a.href='/presence/export.xlsx'+(v?('?q='+encodeURIComponent(v)):'');}})(this)"
              >
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Найти</button>
            </div>
            <div class="col-md-2">
              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
                <div class="small text-secondary htmx-indicator">Поиск...</div>
              </div>
            </div>
          </form>

          <div class="small text-secondary mt-2">
            Данные накапливаются фоновым сканированием. Хранение сопоставлений — 31 день.
          </div>

          <div id="presence-results" class="mt-3" hx-get="/presence/search" hx-trigger="load" hx-swap="innerHTML"></div>
        </div>

        <div class="tab-pane fade" id="pane-users" role="tabpanel" aria-labelledby="tab-users">
          <h2 class="h6 mb-3">Поиск пользователей в AD</h2>

          <form
            class="row g-2 align-items-center"
            hx-get="/users/search"
            hx-target="#user-results"
            hx-swap="innerHTML"
          >
            <div class="col-md-8">
              <input
                type="text"
                class="form-control"
                name="q"
                placeholder="Имя, фамилия или логин (часть)"
                autocomplete="off"
              >
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Найти</button>
            </div>
            <div class="col-md-2">
              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
                <div class="small text-secondary htmx-indicator">Поиск...</div>
              </div>
            </div>
          </form>

          <div class="small text-secondary mt-2">
            Поиск выполняется по части имени, фамилии или логина. В «Подробнее» пустые поля не отображаются.
          </div>

          <div id="user-results" class="mt-3"></div>
        </div>

        <div class="tab-pane fade" id="pane-host" role="tabpanel" aria-labelledby="tab-host">
          <h2 class="h6 mb-3">Кто залогинен на хосте</h2>

          <form
            class="row g-2 align-items-center"
            hx-get="/hosts/logon"
            hx-target="#host-logon-results"
            hx-swap="innerHTML"
          >
            <div class="col-md-8">
              <input
                type="text"
                class="form-control"
                name="target"
                placeholder="Имя хоста (например, prod-00835) или IP"
                autocomplete="off"
              >
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Проверить</button>
            </div>
            <div class="col-md-2">
              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
                <div class="small text-secondary htmx-indicator">Поиск...</div>
              </div>
            </div>
          </form>

          <div class="small text-secondary mt-2">
            Способы перебираются по очереди: WinRM → WMI → SMB. Таймаут на каждый способ задаётся в «Настройках».
          </div>

          <div id="host-logon-results" class="mt-3"></div>
        </div>

      </div>
    </div>
  </div>

  {# User details modal (filled via HTMX) #}
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" id="userModalContent">
        <div class="modal-body">
          <div class="small text-secondary">Загрузка…</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // When HTMX swaps modal content, show the Bootstrap modal.
    document.body.addEventListener('htmx:afterSwap', function (evt) {
      var tgt = evt.detail && evt.detail.target;
      if (!tgt) return;
      if (tgt.id === 'userModalContent') {
        var el = document.getElementById('userModal');
        if (!el || !window.bootstrap) return;
        var m = bootstrap.Modal.getOrCreateInstance(el);
        m.show();
      }
    });
  </script>
{% endblock %}
