{% extends "base_public.html" %}
{% block content %}

{#
  Default tab:
  - If AD auth mode is enabled, show AD tab by default
  - If there is an error, keep the corresponding tab active
#}
{% set active_tab = "ad" if auth_mode == "ad" else "local" %}
{% if error_local %}{% set active_tab = "local" %}{% endif %}
{% if error_ad and not error_local %}{% set active_tab = "ad" %}{% endif %}

<div class="auth-center">
  <div class="auth-box">
    <div class="text-center mb-3">
      <div class="auth-title">AD Tools</div>
      <div class="text-secondary small">
        Вход · режим: <strong>{{ auth_mode|upper }}</strong>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-4">

    <ul class="nav nav-pills mb-3" id="authTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link {% if active_tab == 'local' %}active{% endif %}"
          data-bs-toggle="pill"
          data-bs-target="#pane-local"
          type="button"
          role="tab"
        >Локальный вход</button>
      </li>

      <li class="nav-item" role="presentation">
        <button
          class="nav-link {% if active_tab == 'ad' %}active{% endif %}"
          data-bs-toggle="pill"
          data-bs-target="#pane-ad"
          type="button"
          role="tab"
        >Вход через AD</button>
      </li>
    </ul>

    <div class="tab-content">

      <div class="tab-pane fade {% if active_tab == 'local' %}show active{% endif %}" id="pane-local" role="tabpanel">
        <div id="login-result-local" class="mb-3">
          {% if error_local %}
            <div class="alert alert-danger py-2 mb-0">{{ error_local }}</div>
          {% endif %}
        </div>

        <form
          method="post"
          action="/login/local"
          hx-post="/login/local"
          hx-target="#login-result-local"
          hx-swap="innerHTML"
        >
          <div class="mb-3">
            <label class="form-label fw-semibold">Логин</label>
            <input name="username" class="form-control" autocomplete="username">
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Пароль</label>
            <input name="password" type="password" class="form-control" autocomplete="current-password">
          </div>
          <button class="btn btn-primary w-100">Войти</button>
        </form>

        <div class="text-secondary small mt-3">
          Локальный администратор всегда может войти для обслуживания (break-glass).
        </div>
      </div>

      <div class="tab-pane fade {% if active_tab == 'ad' %}show active{% endif %}" id="pane-ad" role="tabpanel">

        {% if auth_mode != "ad" %}
          <div class="alert alert-warning py-2">
            AD-вход сейчас отключён. Включите его в <a href="/settings">настройках</a>.
          </div>
        {% endif %}

        <div id="login-result-ad" class="mb-3">
          {% if error_ad %}
            <div class="alert alert-danger py-2 mb-0">{{ error_ad }}</div>
          {% endif %}
        </div>

        <form
          method="post"
          action="/login/ad"
          hx-post="/login/ad"
          hx-target="#login-result-ad"
          hx-swap="innerHTML"
        >
          <div class="mb-3">
            <label class="form-label fw-semibold">Логин</label>
            <input
              name="username"
              class="form-control"
              placeholder="sAMAccountName или user@domain"
              autocomplete="username"
              {% if auth_mode != "ad" %}disabled{% endif %}
            >
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Пароль</label>
            <input
              name="password"
              type="password"
              class="form-control"
              autocomplete="current-password"
              {% if auth_mode != "ad" %}disabled{% endif %}
            >
          </div>
          <button class="btn btn-outline-primary w-100" {% if auth_mode != "ad" %}disabled{% endif %}>
            Войти через AD
          </button>
        </form>

        <div class="text-secondary small mt-3">
          Доступ определяется выбранными группами.
        </div>
      </div>

    </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Clear stale alerts when switching between LOCAL/AD tabs.
  (function () {
    function clearEl(id) {
      var el = document.getElementById(id);
      if (el) el.innerHTML = "";
    }
    document.addEventListener('shown.bs.tab', function (ev) {
      var t = ev && ev.target;
      if (!t) return;
      if (!t.closest || !t.closest('#authTabs')) return;
      clearEl('login-result-local');
      clearEl('login-result-ad');
    });
  })();
</script>

{% endblock %}
