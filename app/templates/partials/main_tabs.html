<div class="card shadow-sm mt-3">
  <div class="card-body">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      {% if net_scan_ready %}
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-presence" data-bs-toggle="tab" data-bs-target="#pane-presence" type="button" role="tab" aria-controls="pane-presence" aria-selected="true">
          Сопоставления
        </button>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if not net_scan_ready %}active{% endif %}" id="tab-users" data-bs-toggle="tab" data-bs-target="#pane-users" type="button" role="tab" aria-controls="pane-users" aria-selected="false">
          Поиск пользователей
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-host" data-bs-toggle="tab" data-bs-target="#pane-host" type="button" role="tab" aria-controls="pane-host" aria-selected="false">
          Кто залогинен на хосте
        </button>
      </li>
    </ul>

    <div class="tab-content pt-3" id="mainTabsContent">

      {% if net_scan_ready %}
      <div class="tab-pane fade show active" id="pane-presence" role="tabpanel" aria-labelledby="tab-presence">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-2">
            <h2 class="h6 mb-0">Сопоставления user ↔ host</h2>
            <a class="btn btn-outline-secondary btn-sm" id="presence-export" href="/presence/export.xlsx">Скачать XLSX</a>
          </div>

          <form
            class="row g-2 align-items-center"
            hx-get="/presence/search"
            hx-target="#presence-results"
            hx-swap="innerHTML"
            hx-trigger="submit, keyup changed delay:350ms from:input[name='q']"
          >
            <div class="col-md-8">
              <input
                type="text"
                class="form-control"
                name="q"
                placeholder="Поиск по имени хоста, IP или логину"
                autocomplete="off"
                oninput="(function(el){var v=(el.value||'').trim();var a=document.getElementById('presence-export');if(a){a.href='/presence/export.xlsx'+(v?('?q='+encodeURIComponent(v)):'');}})(this)"
              >
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Найти</button>
            </div>
            <div class="col-md-2">
              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
                <div class="small text-secondary htmx-indicator">Поиск...</div>
              </div>
            </div>
          </form>

          <div class="small text-secondary mt-2">
            Данные накапливаются фоновым сканированием. Хранение сопоставлений — 31 день.
          </div>

          <div id="presence-results" class="mt-3" hx-get="/presence/search" hx-trigger="load" hx-swap="innerHTML"></div>
      </div>
      {% endif %}

<div class="tab-pane fade {% if not net_scan_ready %}show active{% endif %}" id="pane-users" role="tabpanel" aria-labelledby="tab-users">
        <h2 class="h6 mb-3">Поиск пользователей в AD</h2>

        <form
          class="row g-2 align-items-center"
          hx-get="/users/search"
          hx-target="#user-results"
          hx-swap="innerHTML"
          hx-trigger="submit, keyup changed delay:350ms from:input[name='q']"
        >
          <div class="col-md-8">
            <input
              type="text"
              class="form-control"
              name="q"
              placeholder="Имя, фамилия или логин (часть)"
              autocomplete="off"
            >
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">Найти</button>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
              <div class="small text-secondary htmx-indicator">Поиск...</div>
            </div>
          </div>
        </form>

        <div class="small text-secondary mt-2">
          Поиск выполняется по части имени, фамилии или логина. В «Подробнее» пустые поля не отображаются.
        </div>

        <details class="mt-3">
          <summary class="btn btn-outline-secondary btn-sm">Расширенный поиск</summary>
          <div class="mt-2">
            <div class="small text-secondary mb-2">
              Можно загрузить группы из AD и посмотреть состав выбранной группы (пользователи и вложенные группы).
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button
                type="button"
                class="btn btn-outline-primary btn-sm"
                hx-get="/users/ad-groups"
                hx-target="#ad-groups"
                hx-swap="innerHTML"
              >Загрузить группы из AD</button>

              <button
                type="button"
                class="btn btn-outline-warning btn-sm"
                hx-get="/users/ad-disabled"
                hx-target="#ad-group-members"
                hx-swap="innerHTML"
              >Отключенные</button>

              <button
                type="button"
                class="btn btn-outline-info btn-sm"
                hx-get="/users/ad-no-pin"
                hx-target="#ad-group-members"
                hx-swap="innerHTML"
              >ПИН код отсутствует</button>

              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
                <div class="small text-secondary htmx-indicator">Загрузка…</div>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-lg-5">
                <div id="ad-groups" class="border rounded p-2 bg-body-tertiary">
                  <div class="small text-secondary">Нажмите «Загрузить группы из AD».</div>
                </div>
              </div>
              <div class="col-lg-7">
                <div id="ad-group-members" class="border rounded p-2 bg-body-tertiary">
                  <div class="small text-secondary">Выберите группу слева, чтобы увидеть состав.</div>
                </div>
              </div>
            </div>
          </div>
        </details>

        <div id="user-results" class="mt-3"></div>
      </div>

      <div class="tab-pane fade" id="pane-host" role="tabpanel" aria-labelledby="tab-host">
        <h2 class="h6 mb-3">Кто залогинен на хосте</h2>

        <form
          class="row g-2 align-items-center"
          hx-get="/hosts/logon"
          hx-target="#host-logon-results"
          hx-swap="innerHTML"
          hx-trigger="submit, keyup changed delay:350ms from:input[name='target']"
        >
          <div class="col-md-8">
            <input
              type="text"
              class="form-control"
              name="target"
              placeholder="Имя хоста (например, prod-00835) или IP"
              autocomplete="off"
            >
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">Проверить</button>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
              <div class="small text-secondary htmx-indicator">Поиск...</div>
            </div>
          </div>
        </form>

        <div class="small text-secondary mt-2">
          Способы перебираются по очереди: WinRM → WMI → SMB. Таймаут на каждый способ задаётся в «Настройках».
        </div>

        <div id="host-logon-results" class="mt-3"></div>
      </div>

    </div>
  </div>
</div>
