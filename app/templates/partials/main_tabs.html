<div class="card shadow-sm mt-3">
  <div class="card-body">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      {% if net_scan_ready %}
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-presence" data-bs-toggle="tab" data-bs-target="#pane-presence" type="button" role="tab" aria-controls="pane-presence" aria-selected="true">
          Сопоставления
        </button>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if not net_scan_ready %}active{% endif %}" id="tab-users" data-bs-toggle="tab" data-bs-target="#pane-users" type="button" role="tab" aria-controls="pane-users" aria-selected="false">
          Поиск пользователей
        </button>
      </li>
      {% if net_scan_ready %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-shares" data-bs-toggle="tab" data-bs-target="#pane-shares" type="button" role="tab" aria-controls="pane-shares" aria-selected="false">
          Общие папки
        </button>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-host" data-bs-toggle="tab" data-bs-target="#pane-host" type="button" role="tab" aria-controls="pane-host" aria-selected="false">
          Кто залогинен на хосте
        </button>
      </li>
      {% if ip_phones_ready %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-ip-phones" data-bs-toggle="tab" data-bs-target="#pane-ip-phones" type="button" role="tab" aria-controls="pane-ip-phones" aria-selected="false">
          IP-телефоны
        </button>
      </li>
      {% endif %}
      {% if user.get("settings") %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-ad-mgmt" data-bs-toggle="tab" data-bs-target="#pane-ad-mgmt" type="button" role="tab" aria-controls="pane-ad-mgmt" aria-selected="false">
          Управление AD
        </button>
      </li>
      {% endif %}
    </ul>

    <div class="tab-content pt-3" id="mainTabsContent">

      {% if net_scan_ready %}
      <div class="tab-pane fade show active" id="pane-presence" role="tabpanel" aria-labelledby="tab-presence">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-2">
            <h2 class="h6 mb-0">Сопоставления user ↔ host</h2>
            <a class="btn btn-outline-secondary btn-sm" id="presence-export" href="/presence/export.xlsx">Скачать XLSX</a>
          </div>

          <form
            class="row g-2 align-items-center"
            hx-get="/presence/search"
            hx-target="#presence-results"
            hx-swap="innerHTML"
            hx-trigger="submit, keyup changed delay:350ms from:input[name='q']"
          >
            <div class="col-md-8">
              <input
                type="text"
                class="form-control"
                name="q"
                placeholder="Поиск по имени хоста, IP или логину"
                autocomplete="off"
                oninput="(function(el){var v=(el.value||'').trim();var a=document.getElementById('presence-export');if(a){a.href='/presence/export.xlsx'+(v?('?q='+encodeURIComponent(v)):'');}})(this)"
              >
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Найти</button>
            </div>
            <div class="col-md-2">
              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
                <div class="small text-secondary htmx-indicator">Поиск...</div>
              </div>
            </div>
          </form>

          <div class="small text-secondary mt-2">
            Данные накапливаются фоновым сканированием. Хранение сопоставлений — 31 день.
          </div>

          <div id="presence-results" class="mt-3" hx-get="/presence/search" hx-trigger="load" hx-swap="innerHTML"></div>
      </div>
      {% endif %}

      {% if net_scan_ready %}
      <div class="tab-pane fade" id="pane-shares" role="tabpanel" aria-labelledby="tab-shares">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-2">
            <h2 class="h6 mb-0">Общие папки (SMB-шары)</h2>
            <a class="btn btn-outline-secondary btn-sm" id="shares-export" href="/shares/export.xlsx">Скачать XLSX</a>
          </div>

          <form
            class="row g-2 align-items-center"
            hx-get="/shares/search"
            hx-target="#shares-results"
            hx-swap="innerHTML"
            hx-trigger="submit, keyup changed delay:350ms from:input[name='q']"
            hx-include="[name='hidden']"
          >
            <div class="col-md-6">
              <input
                type="text"
                class="form-control"
                name="q"
                placeholder="Поиск по хосту, IP, имени ресурса или описанию"
                autocomplete="off"
                oninput="(function(el){var v=(el.value||'').trim();var a=document.getElementById('shares-export');if(a){var h=document.getElementById('shares-hidden-cb');var hv=(h&&h.checked)?1:0;a.href='/shares/export.xlsx'+(v?('?q='+encodeURIComponent(v)+'&hidden='+hv):('?hidden='+hv));}})(this)"
              >
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Найти</button>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="shares-hidden-cb"
                  name="hidden"
                  value="1"
                  hx-get="/shares/search"
                  hx-target="#shares-results"
                  hx-swap="innerHTML"
                  hx-include="closest form"
                  hx-trigger="change"
                >
                <label class="form-check-label small" for="shares-hidden-cb">
                  Показать скрытые (ADMIN$, C$, IPC$...)
                </label>
              </div>
            </div>
            <div class="col-md-1">
              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
              </div>
            </div>
          </form>

          <div class="small text-secondary mt-2">
            Данные обновляются после каждого фонового сканирования. Показан только последний снимок.
          </div>

          <div id="shares-results" class="mt-3" hx-get="/shares/search" hx-trigger="load" hx-swap="innerHTML"></div>
      </div>
      {% endif %}

<div class="tab-pane fade {% if not net_scan_ready %}show active{% endif %}" id="pane-users" role="tabpanel" aria-labelledby="tab-users">
        <h2 class="h6 mb-3">Поиск пользователей в AD</h2>

        <form
          class="row g-2 align-items-center"
          hx-get="/users/search"
          hx-target="#user-results"
          hx-swap="innerHTML"
          hx-trigger="submit, keyup changed delay:350ms from:input[name='q']"
        >
          <div class="col-md-8">
            <input
              type="text"
              class="form-control"
              name="q"
              placeholder="Имя, фамилия или логин (часть)"
              autocomplete="off"
            >
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">Найти</button>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
              <div class="small text-secondary htmx-indicator">Поиск...</div>
            </div>
          </div>
        </form>

        <div class="small text-secondary mt-2">
          Поиск выполняется по части имени, фамилии или логина. В «Подробнее» пустые поля не отображаются.
        </div>

        <details class="mt-3">
          <summary class="btn btn-outline-secondary btn-sm">Расширенный поиск</summary>
          <div class="mt-2">
            <div class="small text-secondary mb-2">
              Можно загрузить группы из AD и посмотреть состав выбранной группы (пользователи и вложенные группы).
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button
                type="button"
                class="btn btn-outline-primary btn-sm"
                hx-get="/users/ad-groups"
                hx-target="#ad-groups"
                hx-swap="innerHTML"
              >Загрузить группы из AD</button>

              <button
                type="button"
                class="btn btn-outline-warning btn-sm"
                hx-get="/users/ad-disabled"
                hx-target="#ad-group-members"
                hx-swap="innerHTML"
              >Отключенные</button>

              <button
                type="button"
                class="btn btn-outline-info btn-sm"
                hx-get="/users/ad-no-pin"
                hx-target="#ad-group-members"
                hx-swap="innerHTML"
              >ПИН код отсутствует</button>

              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
                <div class="small text-secondary htmx-indicator">Загрузка…</div>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-lg-5">
                <div id="ad-groups" class="border rounded p-2 bg-body-tertiary">
                  <div class="small text-secondary">Нажмите «Загрузить группы из AD».</div>
                </div>
              </div>
              <div class="col-lg-7">
                <div id="ad-group-members" class="border rounded p-2 bg-body-tertiary">
                  <div class="small text-secondary">Выберите группу слева, чтобы увидеть состав.</div>
                </div>
              </div>
            </div>
          </div>
        </details>

        <div id="user-results" class="mt-3"></div>
      </div>

      <div class="tab-pane fade" id="pane-host" role="tabpanel" aria-labelledby="tab-host">
        <h2 class="h6 mb-3">Кто залогинен на хосте</h2>

        <form
          class="row g-2 align-items-center"
          hx-get="/hosts/logon"
          hx-target="#host-logon-results"
          hx-swap="innerHTML"
          hx-trigger="submit, keyup changed delay:350ms from:input[name='target']"
        >
          <div class="col-md-8">
            <input
              type="text"
              class="form-control"
              name="target"
              placeholder="Имя хоста (например, prod-00835) или IP"
              autocomplete="off"
            >
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">Проверить</button>
          </div>
          <div class="col-md-2">
            <div class="d-flex align-items-center gap-2">
              <div class="spinner-border spinner-border-sm text-secondary htmx-indicator" role="status" aria-hidden="true"></div>
              <div class="small text-secondary htmx-indicator">Поиск...</div>
            </div>
          </div>
        </form>

        <div class="small text-secondary mt-2">
          Способы перебираются по очереди: WinRM → WMI → SMB. Таймаут на каждый способ задаётся в «Настройках».
        </div>

        <div id="host-logon-results" class="mt-3"></div>
      </div>

      {% if ip_phones_ready %}
      <div
        class="tab-pane fade"
        id="pane-ip-phones"
        role="tabpanel"
        aria-labelledby="tab-ip-phones"
        hx-get="/ip-phones"
        hx-trigger="revealed"
        hx-target="#pane-ip-phones"
        hx-swap="innerHTML"
      >
        <div class="text-secondary small">Загрузка...</div>
      </div>
      {% endif %}

      {% if user.get("settings") %}
      <div
        class="tab-pane fade"
        id="pane-ad-mgmt"
        role="tabpanel"
        aria-labelledby="tab-ad-mgmt"
        hx-get="/ad-management"
        hx-trigger="revealed"
        hx-target="#pane-ad-mgmt"
        hx-swap="innerHTML"
      >
        <div class="text-secondary small">Загрузка...</div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

{% if user.get("settings") %}
<script>
  /* Универсальная функция закрытия модалки AD-управления.
     Определена в main_tabs (server-side render) — всегда доступна для onclick в HTMX-фрагментах. */
  function closeAdMgmtModal() {
    var c = document.getElementById('ad-mgmt-modal');
    if (c) c.innerHTML = '';
  }
  function handleAdMgmtModalResponse(ev) {
    var t = (ev.detail.xhr && ev.detail.xhr.responseText) || '';
    if (t.indexOf('alert-success') !== -1) {
      setTimeout(closeAdMgmtModal, 1200);
    }
  }
  function addMemberToGroup(memberDn) {
    var section = document.getElementById('group-members-section');
    if (!section) return;
    var groupDn = section.dataset.groupDn;
    htmx.ajax('POST', '/ad-management/group-add-member',
      {target: '#group-members-section', swap: 'outerHTML',
       values: {group_dn: groupDn, member_dn: memberDn}});
  }
  function editUserAddGroup(groupDn) {
    var section = document.getElementById('user-edit-groups-section');
    if (!section) return;
    var userDn = section.dataset.userDn;
    htmx.ajax('POST', '/ad-management/edit-user-add-group',
      {target: '#user-edit-groups-section', swap: 'outerHTML',
       values: {user_dn: userDn, group_dn: groupDn}});
  }
  function addWizardGroup(dn, name) {
    var list = document.getElementById('wizard-groups-list');
    if (!list) return;
    // Проверка дубликата
    var inputs = list.querySelectorAll('input[name="groups"]');
    for (var i = 0; i < inputs.length; i++) {
      if (inputs[i].value === dn) return;
    }
    // Создать flex-обёртку если нет
    var wrap = list.querySelector('.wiz-groups-wrap');
    if (!wrap) {
      list.innerHTML = '';
      wrap = document.createElement('div');
      wrap.className = 'd-flex flex-wrap gap-1 wiz-groups-wrap';
      list.appendChild(wrap);
    }
    // Добавить badge + hidden input
    var entry = document.createElement('span');
    entry.className = 'group-entry d-inline-flex align-items-center';
    entry.innerHTML = '<input type="hidden" name="groups" value="' + dn.replace(/"/g, '&quot;') + '">'
      + '<span class="badge bg-secondary d-inline-flex align-items-center">'
      + name.replace(/</g, '&lt;')
      + '<button type="button" class="btn-close btn-close-white ms-1" style="font-size:.5em" '
      + 'onclick="this.closest(\'.group-entry\').remove()" aria-label="Удалить"></button></span>';
    wrap.appendChild(entry);
  }
</script>
{% endif %}
