<div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,.5)">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Создание пользователя &mdash; Шаг 2 из 4</h5>
        <button type="button" class="btn-close" onclick="closeAdMgmtModal()" aria-label="Close"></button>
      </div>
      <form
        hx-post="/ad-management/create-user-step3"
        hx-target="#ad-mgmt-modal"
        hx-swap="innerHTML"
      >
        <input type="hidden" name="ou" value="{{ ou }}">
        <div class="modal-body">
          <h6 class="mb-1">Выберите пользователя для копирования</h6>
          <p class="text-secondary small mb-1">Группы, организация, отдел и должность будут скопированы. Можно пропустить этот шаг.</p>
          <div class="small text-secondary mb-2">OU: <code>{{ ou_label }}</code></div>

          {% if error %}
            <div class="alert alert-danger small">{{ error }}</div>
          {% endif %}

          {% if users %}
            <input type="text" class="form-control form-control-sm mb-2"
              placeholder="Фильтр по имени или логину..."
              oninput="var q=this.value.toLowerCase().trim();document.querySelectorAll('.tpl-user-item').forEach(function(el){el.classList.toggle('d-none',!(!q||(el.getAttribute('data-name')||'').indexOf(q)!==-1))})">
            <div class="border rounded bg-body-tertiary" style="max-height:300px;overflow-y:auto">
              <div class="list-group list-group-flush small">
                {% for u in users %}
                  <label class="list-group-item list-group-item-action d-flex align-items-center py-1 px-2 tpl-user-item"
                    data-name="{{ u.display|lower }} {{ u.sam|lower }}">
                    <input type="radio" name="template_user_dn" value="{{ u.dn }}" class="form-check-input me-2 flex-shrink-0">
                    <span>
                      <strong>{{ u.display or u.sam }}</strong>
                      {% if u.sam %}<span class="text-secondary">({{ u.sam }})</span>{% endif %}
                      {% if u.title %}<span class="text-secondary ms-1">&mdash; {{ u.title }}</span>{% endif %}
                    </span>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="form-text">Выберите пользователя и нажмите &laquo;Далее&raquo;, или нажмите &laquo;Пропустить&raquo;.</div>
          {% else %}
            <div class="alert alert-info small mb-0">В выбранной OU нет активных пользователей. Нажмите &laquo;Далее&raquo; для продолжения без шаблона.</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary"
            hx-get="/ad-management/create-user-wizard"
            hx-target="#ad-mgmt-modal"
            hx-swap="innerHTML"
          >&larr; Назад</button>
          <button type="button" class="btn btn-secondary" onclick="closeAdMgmtModal()">Отмена</button>
          <button type="submit" class="btn btn-primary">Далее &rarr;</button>
        </div>
      </form>
    </div>
  </div>
</div>
