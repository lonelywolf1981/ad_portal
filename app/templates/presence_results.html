{% if not items or items|length == 0 %}
  <div class="alert alert-secondary py-2 mb-0">
    {% if q %}
      Ничего не найдено.
    {% else %}
      Пока нет данных. Дождитесь фонового сканирования или запустите его вручную в «Настройках».
    {% endif %}
  </div>
{% else %}
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr class="small text-secondary">
          {% set _q = q or '' %}
          {% set _sort = sort or 'when' %}
          {% set _dir = dir or 'desc' %}

          {% macro sort_link(label, field) -%}
            {%- set next_dir = 'desc' if _sort != field else ('asc' if _dir == 'desc' else 'desc') -%}
            {%- set arrow = '' -%}
            {%- if _sort == field -%}
              {%- set arrow = ' ▼' if _dir == 'desc' else ' ▲' -%}
            {%- endif -%}
            <a
              href="#"
              class="link-underline link-underline-opacity-0 text-secondary"
              hx-get="/presence/search?q={{ _q|urlencode }}&sort={{ field }}&dir={{ next_dir }}"
              hx-target="#presence-results"
              hx-swap="innerHTML"
              onclick="return false;"
            >{{ label }}{{ arrow }}</a>
          {%- endmacro %}

          <th style="min-width: 220px;">{{ sort_link('Имя хоста', 'host') }}</th>
          <th style="min-width: 140px;">{{ sort_link('IP', 'ip') }}</th>
          <th style="min-width: 160px;">{{ sort_link('Логин', 'login') }}</th>
          <th style="min-width: 180px;">{{ sort_link('Когда обнаружено', 'when') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
          <tr>
            <td><span class="fw-semibold">{{ r.host if r.host else "—" }}</span></td>
            <td>
              {% if r.ip %}
                {# выделяем сам IP цветом подсети, подсеть текстом не показываем #}
                <span class="badge {{ r.subnet_class }}">{{ r.ip }}</span>
              {% else %}
                <span class="text-secondary">—</span>
              {% endif %}
            </td>
            <td>
              {% if r.login %}
                <a
                  href="#"
                  class="link-underline link-underline-opacity-0"
                  hx-get="/users/view?login={{ r.login|urlencode }}&modal=1"
                  hx-target="#userModalContent"
                  hx-swap="innerHTML"
                  onclick="return false;"
                ><code>{{ r.login }}</code></a>
              {% else %}
                <span class="text-secondary">—</span>
              {% endif %}
            </td>
            <td class="text-secondary">{{ r.when if r.when else "—" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Экспортная ссылка по умолчанию синхронизируется через oninput в форме (по q).
     Параметры sort/dir поддерживаются эндпоинтом /presence/export.xlsx при необходимости. #}
{% endif %}
