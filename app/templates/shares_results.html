{% set _q = q or '' %}
{% set _sort = sort or 'host' %}
{% set _dir = dir or 'asc' %}
{% set _hidden = hidden or 0 %}

{% if action_result %}
  {% set _ok = action_result.ok if action_result.ok is defined else false %}
  <div class="alert {{ 'alert-success' if _ok else 'alert-danger' }} py-2 mb-2">
    {{ action_result.message if action_result.message else '' }}
    {% if action_result.details %}
      <div class="small mt-1">{{ action_result.details }}</div>
    {% endif %}
  </div>
{% endif %}

{% if not groups or groups|length == 0 %}
  <div class="alert alert-secondary py-2 mb-0">
    {% if q %}
      –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
    {% else %}
      –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ñ–æ–Ω–æ–≤–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª.
    {% endif %}
  </div>
{% else %}
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
    <div class="d-flex align-items-center gap-2 small text-secondary">
      {% macro sort_link(label, field) -%}
        {%- set next_dir = 'desc' if _sort != field else ('asc' if _dir == 'desc' else 'desc') -%}
        {%- set arrow = '' -%}
        {%- if _sort == field -%}
          {%- set arrow = ' ‚ñº' if _dir == 'desc' else ' ‚ñ≤' -%}
        {%- endif -%}
        <a
          href="#"
          class="link-underline link-underline-opacity-0 text-secondary"
          hx-get="/shares/search?q={{ _q|urlencode }}&sort={{ field }}&dir={{ next_dir }}&hidden={{ _hidden }}"
          hx-target="#shares-results"
          hx-swap="innerHTML"
          onclick="return false;"
        >{{ label }}{{ arrow }}</a>
      {%- endmacro %}
      <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
      {{ sort_link('–•–æ—Å—Ç', 'host') }}
      <span>‚Ä¢</span>
      {{ sort_link('IP', 'ip') }}
      <span>‚Ä¢</span>
      {{ sort_link('–†–µ—Å—É—Ä—Å', 'name') }}
      <span>‚Ä¢</span>
      {{ sort_link('–¢–∏–ø', 'type') }}
      <span>‚Ä¢</span>
      {{ sort_link('–ö–æ–≥–¥–∞', 'when') }}
    </div>

    <div class="btn-group btn-group-sm" role="group" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º —Ö–æ—Å—Ç–æ–≤">
      <button type="button" class="btn btn-outline-secondary" onclick="window.adpSetSharesOpen(true); return false;">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      <button type="button" class="btn btn-outline-secondary" onclick="window.adpSetSharesOpen(false); return false;">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
    </div>
  </div>

	  <script>
	    // Used by the "Expand/Collapse all" buttons in the Shares tab.
	    window.adpSetSharesOpen = window.adpSetSharesOpen || function(open) {
	      try {
	        var root = document.getElementById("shares-results");
	        if (!root) return;
	        var nodes = root.querySelectorAll("details");
	        for (var i = 0; i < nodes.length; i++) {
	          nodes[i].open = !!open;
	        }
	      } catch (_e) {}
	    };

	    // Browsers often block direct navigation to file:// from http(s).
	    // So we do best-effort:
	    // 1) copy UNC path to clipboard
	    // 2) try to open via file:// (may be blocked by browser policy)
	    window.adpOpenShare = window.adpOpenShare || async function(host, shareName) {
	      try {
	        host = (host || "").trim();
	        shareName = (shareName || "").trim();
	        if (!host || !shareName) return false;

	        var unc = "\\\\" + host + "\\" + shareName;

	        // Copy path so user can paste into Explorer even if open is blocked.
	        try {
	          if (navigator.clipboard && navigator.clipboard.writeText) {
	            await navigator.clipboard.writeText(unc);
	          } else {
	            throw new Error("no-clipboard");
	          }
	        } catch (_e1) {
	          try { window.prompt("–ü—É—Ç—å –∫ —Ä–µ—Å—É—Ä—Å—É (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ):", unc); } catch (_e2) {}
	        }

	        // Try to open. This may do nothing depending on browser security settings.
	        try {
	          var url = "file://///" + encodeURIComponent(host) + "/" + encodeURIComponent(shareName);
	          window.open(url, "_blank");
	        } catch (_e3) {}
	        return false;
	      } catch (_e4) {
	        return false;
	      }
	    };
	  </script>

	  <style>
	    /* Shares tab: make share links feel like interactive "chips" instead of default blue anchors. */
	    .adp-share-link {
	      display: inline-flex;
	      align-items: center;
	      gap: 0.35rem;
	      padding: 0.14rem 0.45rem;
	      border-radius: 999px;
	      border: 1px solid rgba(233, 30, 99, 0.25);
	      background: rgba(233, 30, 99, 0.06);
	      color: #ff4fa1; /* bright pink accent */
	      text-decoration: none;
	      transition: background-color 140ms ease, border-color 140ms ease, transform 140ms ease;
	    }
	    .adp-share-link[data-share-kind="print"] {
	      border-color: rgba(255, 152, 0, 0.28);
	      background: rgba(255, 152, 0, 0.08);
	      color: #ffb74d;
	    }
	    .adp-share-link[data-share-kind="ipc"] {
	      border-color: rgba(0, 188, 212, 0.28);
	      background: rgba(0, 188, 212, 0.08);
	      color: #4dd0e1;
	    }
	    .adp-share-link[data-share-kind="device"] {
	      border-color: rgba(0, 200, 83, 0.26);
	      background: rgba(0, 200, 83, 0.08);
	      color: #69f0ae;
	    }
	    .adp-share-link[data-share-kind="hidden"] {
	      border-color: rgba(176, 190, 197, 0.35);
	      background: rgba(176, 190, 197, 0.08);
	      color: #cfd8dc;
	    }
	    .adp-share-link:hover,
	    .adp-share-link:focus-visible {
	      background: rgba(233, 30, 99, 0.12);
	      border-color: rgba(233, 30, 99, 0.45);
	      color: #ff68b2;
	      transform: translateY(-1px);
	    }
	    .adp-share-link:active {
	      transform: translateY(0);
	    }
	    .adp-share-link code {
	      color: inherit;
	    }
	    .adp-share-link .adp-share-ico {
	      opacity: 0.9;
	      font-size: 0.95em;
	      line-height: 1;
	    }
	  </style>

  <div class="d-flex flex-column gap-2">
    {% for g in groups %}
      <details class="border rounded p-2" open>
        <summary class="d-flex justify-content-between align-items-center flex-wrap gap-2" style="cursor:pointer;">
          <span class="d-inline-flex align-items-center gap-2">
            <span class="fw-semibold">{{ g.host if g.host else "‚Äî" }}</span>
            {% if g.ip %}
              <span class="badge {{ g.subnet_class }}">{{ g.ip }}</span>
            {% else %}
              <span class="text-secondary">‚Äî</span>
            {% endif %}
          </span>
          <span class="small text-secondary">–†–µ—Å—É—Ä—Å–æ–≤: {{ g["items"]|length }}</span>
        </summary>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr class="small text-secondary">
                <th style="min-width: 160px;">–ò–º—è —Ä–µ—Å—É—Ä—Å–∞</th>
                <th style="min-width: 120px;">–¢–∏–ø</th>
                <th style="min-width: 180px;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th style="min-width: 170px;">–ö–æ–≥–¥–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</th>
                <th style="min-width: 170px;">–î–µ–π—Å—Ç–≤–∏–µ</th>
              </tr>
            </thead>
	            <tbody>
	              {% for r in g["items"] %}
	                <tr>
	                  {% set _host = g.host if g.host else g.ip %}
	                  {% set _share_display = r.share_name_display if r.share_name_display else "‚Äî" %}
	                  <td>
	                    {% if _host and r.share_name %}
	                      <a
	                        class="adp-share-link"
	                        href="#"
	                        data-share-kind="{{ r.share_kind if r.share_kind else 'disk' }}"
	                        onclick="window.adpOpenShare('{{ _host|e }}','{{ r.share_name|e }}'); return false;"
	                        title="–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–µ: \\\\{{ _host }}\\{{ r.share_name }} (–ø—É—Ç—å –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω)"
	                      ><span class="adp-share-ico" aria-hidden="true">{{ r.share_icon if r.share_icon else 'üìÅ' }}</span><code>{{ _share_display }}</code></a>
	                    {% else %}
	                      <code>{{ _share_display }}</code>
	                    {% endif %}
	                  </td>
	                  <td class="small">{{ r.share_type }}</td>
	                  <td class="small text-secondary">{{ r.remark if r.remark else "" }}</td>
	                  <td class="text-secondary small">{{ r.when if r.when else "‚Äî" }}</td>
	                  <td>
                    {% if r.can_close %}
                      <form
                        hx-post="/shares/close"
                        hx-target="#shares-results"
                        hx-swap="innerHTML"
                        onsubmit="return confirm('–ó–∞–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å—É {{ (r.share_name_display if r.share_name_display else r.share_name) }} –Ω–∞ —Ö–æ—Å—Ç–µ {{ g.host if g.host else g.ip }}?');"
                      >
                        <input type="hidden" name="host" value="{{ g.host }}">
                        <input type="hidden" name="ip" value="{{ g.ip }}">
                        <input type="hidden" name="share_name" value="{{ r.share_name }}">
                        <input type="hidden" name="q" value="{{ _q }}">
                        <input type="hidden" name="sort" value="{{ _sort }}">
                        <input type="hidden" name="dir" value="{{ _dir }}">
                        <input type="hidden" name="hidden" value="{{ _hidden }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm">–ó–∞–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø</button>
                      </form>
                    {% else %}
                      <span class="small text-secondary">–°–∏—Å—Ç–µ–º–Ω—ã–π —Ä–µ—Å—É—Ä—Å</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    {% endfor %}
  </div>
{% endif %}
