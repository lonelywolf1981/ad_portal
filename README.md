# AD Portal

**AD Portal** — веб‑портал для инфраструктуры **Active Directory** (справочные задачи и контроль доступа).

## Возможности

### Аутентификация и доступ
- **LOCAL**: локальные пользователи приложения (SQLite).
- **AD**: вход через Active Directory (LDAP/LDAPS).
- **Раздельные группы доступа**:
  - кто может входить в приложение;
  - кто может открывать страницу «Настройки».
- **Break‑glass**: локальный администратор может входить даже при включённом режиме AD (чтобы не потерять доступ к настройкам).

### Поиск пользователей в AD
- Поиск по части **имени / фамилии / логина**.
- Вывод в кратком виде: **ФИО, логин, e‑mail**.
- В карточке пользователя — переключатель **«Подробнее»**:
  - показывается расширенная информация из AD;
  - **пустые поля не выводятся**;
  - группы отображаются «человеко‑удобно» (короткими именами).

### Кто залогинен на хосте (WinRM/WMI/SMB)
- По введённому **hostname** (например, `prod-00835`) или **IP** определяется, кто залогинен на удалённой Windows‑машине.
- Если введено короткое имя хоста и в настройках задан домен, пробуются цели:
  1) `hostname.<ad_domain>`
  2) `hostname`
- Методы перебираются **последовательно** до первого результата:
  1) **WinRM**
  2) **WMI/DCOM**
  3) **SMB/RPC**
- На **каждый метод** действует таймаут (настраивается в «Настройках»). Если метод не дал ответ за таймаут — считается неуспешным и запускается следующий.
- В UI доступна кнопка **«Подробности»** (таблица статусов попыток: ok/empty/timeout/error).

### Фоновое сканирование сети (последний хост пользователя)

Дополнительно реализовано периодическое сканирование заданных **CIDR‑диапазонов**, чтобы получить ответ:
**«на каком хосте был найден пользователь»**.

Как это работает:
- В **Настройках** включаете блок **«Фоновое сканирование сети (последний хост)»**.
- Указываете **интервал** (например, 120 минут) и список **CIDR** (по одному в строке).
- Сканирование выполняется в фоне (Celery Beat → Celery Worker).
- При поиске пользователей в AD их карточки автоматически дополняются полем **«Найден на: HOST / IP»** (если для этого логина есть данные в базе).

Оптимизации:
- Для каждого IP делается быстрая **проба портов** (445/5985/5986/135) и не‑Windows хосты пропускаются.
- Пытается получить **hostname** по reverse DNS и сохраняет **hostname + IP**.

Ограничения:
- В таблице хранится **последний** найденный хост для логина (если пользователь найден на нескольких хостах, останется последнее обновление).
- Точность зависит от прав учетной записи, указанной в «Кто залогинен на хосте».

## Технологии
- Backend: **FastAPI**, **SQLAlchemy**, **SQLite**
- Frontend: **Jinja2 Templates**, **HTMX**, **Bootstrap**
- AD/LDAP: **ldap3**
- Remote logon check: **pywinrm**, **requests-ntlm**, **impacket**
- Reverse proxy: **Nginx**
- Runtime: **Docker Compose**
- В составе compose присутствуют **Redis + Celery worker + Celery beat** (фоновые задачи и расписание).

## Быстрый запуск (Docker Compose)

### 1) Подготовка
```bash
cp .env.example .env
mkdir -p data
# если контейнер не может писать SQLite:
sudo chmod 777 data
```

Важно: в `docker-compose.yml` укажите DNS вашего AD (обычно контроллер домена), чтобы корректно резолвились FQDN:
```yaml
dns:
  - 192.168.66.11
```

### 2) Запуск
```bash
docker compose up -d --build
```

### 3) Открыть в браузере
- `http://<IP_хоста>:8484/login`

Порт `8484` задаётся в `docker-compose.yml` (сервис `nginx`).

## Переменные окружения (.env)

Файл `.env.example` — шаблон. Ключевые параметры:

- `APP_SECRET_KEY` — **обязательно** длинный случайный секрет.
  - Используется для подписи cookie‑сессии и для шифрования паролей в БД.
  - Не меняйте ключ после ввода паролей в настройках: смена ключа сделает старые зашифрованные значения нечитаемыми.
- `APP_COOKIE_SECURE` — ставьте `true`, если работаете через HTTPS.
- `SQLITE_PATH` — путь к SQLite (в compose по умолчанию `/app/data/app.db`).
- `BOOTSTRAP_ADMIN_USER`, `BOOTSTRAP_ADMIN_PASSWORD` — bootstrap‑админ создаётся при первом запуске, если локальных пользователей ещё нет.
- `REDIS_URL` — Redis для Celery.

## Первый вход
После старта используйте bootstrap‑пользователя из `.env` и откройте:
- `http://<IP_хоста>:8484/settings`

## Настройка AD

На странице «Настройки»:
1) Укажите параметры AD:
   - **DC**: короткое имя, например `DC1`
   - **Домен**: например `ubc.local.net`
   - **Способ подключения**: `LDAPS (636)` или `LDAP + StartTLS (389)`
   - **Bind user**: только имя пользователя (например `ldap_bind`)
   - **Bind password**: вводится только при смене (если пусто — не меняется)
2) Нажмите **«Проверить и загрузить группы»** — приложение проверит bind и подтянет группы.
3) Выберите:
   - группы **для входа в приложение**;
   - группы **для доступа к настройкам**.
4) Переключите режим авторизации на **AD** и сохраните.

Примечание: проверка «входит ли пользователь в группы» ориентирована на **прямое членство** (без рекурсивного обхода nested‑групп).

## Настройка «Кто залогинен на хосте»

В «Настройках» заполните:
- **Host query user** — учётка для опроса WinRM/WMI/SMB (рекомендуется `DOMAIN\\user`).
- **Host query password** — пароль (если пусто — не меняется).
- **Timeout на способ (сек.)** — ограничение времени на каждый способ (5…300).

Важно: bind‑учётка AD не используется для опроса хостов. Это отдельная учётка.

## Требования по сети и правам

### Для работы с AD
Доступ к контроллеру домена по:
- 389/TCP (LDAP + StartTLS) и/или 636/TCP (LDAPS)
- DNS резолвинг домена (в compose параметр `dns:`)

### Для определения залогиненного пользователя на хосте
На целевом хосте должны быть доступны (в зависимости от метода):
- WinRM: 5985/TCP (HTTP) или 5986/TCP (HTTPS)
- WMI/DCOM: 135/TCP + динамические RPC‑порты (зависит от политики/Firewall)
- SMB/RPC: 445/TCP

Права учётной записи:
- Для WMI/SMB часто требуются административные или расширенные права на целевой машине.
- Если прав/доступа нет — метод вернёт error/timeout, и будет использован следующий способ.

## Обновления и миграции БД
Проект использует SQLite и минимальные «миграции на старте» (без Alembic): при добавлении новых колонок приложение выполняет `ALTER TABLE` перед первым ORM‑запросом.

Рекомендация перед обновлением:
- сделать копию `./data/app.db`.

## Запуск без Docker (для разработки)

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

export APP_SECRET_KEY="CHANGE_ME_LONG_RANDOM"
export SQLITE_PATH="data/app.db"
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

## Структура проекта (основное)
- `app/main.py` — маршруты, UI‑страницы, минимальные миграции SQLite.
- `app/ldap_client.py` — работа с AD (поиск пользователя, проверка пароля, группы).
- `app/host_logon.py` — определение активных пользователей на хосте (WinRM/WMI/SMB).
- `app/templates/` — шаблоны Jinja2 (UI).
- `nginx/conf.d/` — конфиг reverse proxy.

## Troubleshooting

### Контейнер не стартует из‑за SQLite permissions
```bash
mkdir -p data
sudo chmod 777 data
```

### Не резолвятся доменные имена
Проверьте DNS в `docker-compose.yml` (должен быть DNS контроллера домена).

### «Поиск кто залогинен» всегда неудачен
Проверьте по порядку:
- правильные **Host query user/password**;
- доступность портов (5985/5986, 135, 445);
- Firewall/политики WinRM/WMI/SMB на целевой машине;
- формат учётки: предпочтительно `DOMAIN\\user` (особенно если NETBIOS‑имя домена отличается от первой части FQDN).

## Roadmap (идеи)
- Рекурсивная проверка nested‑групп (опционально).
- Кэширование результатов «кто залогинен» на короткое время.
- Фоновые задачи через Celery (длинные операции, массовые проверки).
- Аудит‑лог действий администратора (помимо логина).

---

Если вы выкладываете проект на GitHub: добавьте `.env` и `data/` в `.gitignore` и храните секреты вне репозитория.
